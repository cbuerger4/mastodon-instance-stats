---
title: "Mastodon Data"
date: "`r format(Sys.time(), '%F %H:%M %z (%Z)')`"
output:
  rmdformats::readthedown:
    highlight: kate
    self_contained: no
    lib_dir: "assets"
---

# Data Overview

```{r knitr_init, echo=FALSE, cache=FALSE, include=FALSE}
library(knitr)
library(rmdformats)
library(DT)
library(tidyverse)
library(stringr)
library(purrr)
library(lubridate)
library(ggplot2)
library(tadaatoolbox)

## Global options
options(max.print="75")
opts_chunk$set(echo=FALSE,
	             cache=FALSE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE,
               fig.path="assets/plots/",
               fig.width=7)
opts_knit$set(width=75)

theme_set(tadaatoolbox::theme_readthedown())
```

```{r setup}
mastodon <- read_rds("data/mastodon.rds") %>%
  filter(instance != "sdfn-01.ninjawedding.org")
```

## Tracked instances

For the first two days I scraped the active instances from [the list at  the tootsuite/mastodon repo](https://github.com/tootsuite/mastodon/blob/master/docs/Using-Mastodon/List-of-Mastodon-instances.md), but since it doesn't update regularly because that requires merging pull requests, I switched to the list over at [instances.mastodon.xyz](https://instances.mastodon.xyz/). Please add your instance to this list if you don't find it on here.


```{r instance_list}
mastodon %>%
  group_by(instance) %>%
  summarise(n = n(), users_last = last(users), 
            data_first = min(date), data_last = max(date)) %>%
  arrange(desc(users_last)) %>%
  rename(Instance = instance,
         Data_Points = n,
         Users_Last = users_last,
         First_Data = data_first,
         Last_Data = data_last) %>%
  datatable(rownames = F)
```

## Raw data

```{r raw}
mastodon %>%
  datatable(rownames = F)
```

# TLDs

```{r TLDs, fig.height=9}
mastodon %>%
  distinct(instance) %>%
  mutate(tld = stringr::str_extract(instance, "\\.\\w*$")) %>%
  group_by(tld) %>%
  summarize(n = n(), perc = round((n()/nrow(.)) * 100, 2)) %>%
  ggplot(data = ., aes(x = reorder(tld, n), y = perc)) +
  geom_col() +
  scale_y_continuous(breaks = seq(0, 100, 1)) +
  coord_flip() +
  labs(title = "TLDs Used by Mastodon Instances",
       x = "TLD", y = "Frequency (%)")
```

## TLDs in a Table

```{r TLDs_table}
mastodon %>%
  distinct(instance) %>%
  mutate(tld = stringr::str_extract(instance, "\\.\\w*$")) %>%
  group_by(tld) %>%
  summarize(n = n(), perc = round((n()/nrow(.)) * 100, 2)) %>%
  arrange(desc(perc)) %>%
  datatable(rownames = F)
```


# Instances

## Number of Instances

Limited by available data.

```{r instances_1}
mastodon %>% 
  group_by(date) %>%
  summarize(n = length(unique(instance))) %>%
  ggplot(data = ., aes(x = date, y = n)) +
  geom_col() +
  labs(title = "Number of Mastodon Instances",
       x = "Date", y = "N")
```

## Number of Users per Instance

Current data only.

```{r instances_2}
mastodon %>%
  filter(time == max(time)) %>%
  ggplot(data = ., aes(x = users)) +
  geom_histogram(binwidth = 100) +
  labs(title = "Number of Users per Mastodon Instance",
       x = "User #", y = "Frequency")
```

### Excluding `mastodon.social`

```{r instances_3}
mastodon %>%
  filter(time == max(time), instance != "mastodon.social") %>%
  ggplot(data = ., aes(x = users)) +
  geom_histogram(binwidth = 100) +
  labs(title = "Number of Users per Mastodon Instance",
       subtitle = "Excluding mastodon.social",
       x = "User #", y = "Frequency")
```

## Open vs. Closed Instances

```{r instances_registration}
mastodon %>%
  group_by(date, open_reg) %>%
  filter(!is.na(open_reg)) %>%
  tally() %>%
  ggplot(data = ., aes(x = date, y = n, fill = open_reg)) +
  geom_col() +
  scale_fill_brewer(palette = "Set1") +
  labs(title = "Mastodon Instances by Registration Status",
       subtitle = "Excluding Instances with Unknown Registration Status",
       y = "# of Instances", x = "Date", fill = "Registration")
```

## IPv6 Status

```{r instances_IPv6}
mastodon %>%
  group_by(date, ipv6) %>%
  filter(!is.na(ipv6)) %>%
  tally() %>%
  ggplot(data = ., aes(x = date, y = n, fill = ipv6)) +
  geom_col() +
  scale_fill_brewer(palette = "Set1") +
  labs(title = "Mastodon Instances by IPv6 Status",
       subtitle = "Excluding Instances with Unknown IPv6 Status",
       y = "# of Instances", x = "Date", fill = "Handles IPv6")
```

## HTTPS Score

Only latest data.

```{r instances_HTTPS}
mastodon %>%
  ggplot(data = ., aes(x = https_score, fill = https_rank)) +
  geom_bar(position = "dodge") +
  scale_fill_brewer(palette = "Set1") +
  labs(title = "Mastodon Instances by HTTPS Score",
       y = "# of Instances", x = "HTTPS Score", fill = "HTTPS Rank")
```


## Toots per Instance (Excluding `mastodon.social`)

```{r instances_4}
mastodon %>%
  filter(time == max(time), instance != "mastodon.social") %>%
  ggplot(data = ., aes(x = toots)) +
  geom_histogram(binwidth = 100) +
  labs(title = "Number of Toots per Mastodon Instance",
       subtitle = "Excluding mastodon.social",
       x = "Toot #", y = "Frequency")
```

# Users

```{r users_1}
mastodon %>% 
  group_by(date, instance) %>%
  summarize(n = max(users)) %>%
  ggplot(data = ., aes(x = date, y = n)) +
  geom_col() +
  scale_y_continuous(labels = scales::comma_format()) +
  labs(title = "Number of Mastodon Users",
       subtitle = "Total # Across All Tracked Instances",
       x = "Date", y = "N")
```

```{r users_2}
mastodon %>%
  ggplot(data = ., aes(x = time, y = users, color = instance)) +
  geom_point(size = 1.5) +
  geom_path() +
  scale_y_continuous(labels = scales::comma_format()) +
  scale_color_discrete(guide = F) +
  labs(title = "Number of Mastodon Users",
       subtitle = "Users per Instance",
       x = "Date", y = "N")
```

# About

This is just a quick demo proof of concept by @jemus42@mastodon.social / @jemus42 on twitter.  
A more detailed analysis will come, and I'll probably scrape data daily for long-term analysis.

The site is built in Rmarkdown, using the [readthedown theme from juba/rmdformats](https://github.com/juba/rmdformat).

The code for this project is [on GitHub](https://github.com/jemus42/mastodon-instance-stats).
